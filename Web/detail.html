<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detail Hasil Pemeriksaan Pasien</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: url('img3.png') no-repeat center center fixed;
      background-size: cover;
      padding: 1rem;
      color: #333;
    }

.container {
  max-width: 1200px; /* ðŸ”¹ dari 960px -> 1200px agar ruang lebih lebar */
  margin: auto;
  background: rgba(255, 255, 255, 0.97);
  border-radius: 16px;
  padding: 2rem; /* sedikit lebih besar biar tabel tidak terlalu menempel ke pinggir */
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

    h1 {
      text-align: center;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
      min-width: 700px;
    }

    th, td {
      padding: 10px 14px;
      text-align: center;
      border: 1px solid #ccc;
    }

    th {
      background-color: #007BFF;
      color: white;
    }

    td {
      background-color: #f8f9fa;
    }

    td input {
      width: 100%;
      padding: 6px;
      border: 1px solid #aaa;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.95rem;
      box-sizing: border-box;
    }

    tbody tr:hover {
  background-color: #eef6ff;
  transition: background-color 0.3s ease;
}

    .btn-group {
      text-align: center;
    }

    button {
      padding: 0.6rem 1.2rem;
      margin: 0.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }

    #editBtn {
      background-color: #007BFF;
      color: white;
    }

    #saveBtn {
      background-color: #17a2b8;
      color: white;
      display: none;
    }

    #backBtn {
      background-color: #6c757d;
      color: white;
    }

    #editBtn:hover {
  background-color: #0056b3;
  transform: scale(1.05);
}

#backBtn:hover {
  background-color: #555;
  transform: scale(1.05);
}
#saveBtn:hover {
  background-color: #128495;
  transform: scale(1.05);
}
#addDataBtn {
  background-color: #28a745;
  color: white;
}
#addDataBtn:hover {
  background-color: #218838;
  transform: scale(1.05);
}

    /* === Popup Animasi === */
    #popup-bg {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
      transition: opacity 0.4s ease;
    }

    #popup {
      background: white;
      padding: 1.5rem 2rem;
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    #popup.show {
      opacity: 1;
      transform: scale(1);
    }

    #popup-bg.show {
      display: flex;
      opacity: 1;
    }

    #popup img {
      width: 130px;
      margin-bottom: 1.2rem;
    }

    @media (max-width: 600px) {
      table {
        font-size: 12px;
        min-width: 500px;
      }
      button {
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
      }
    }
/* === Foto & Nama Pasien === */
.photo-section {
  display: flex;
  justify-content: center;
  margin: 20px 0;
}

.photo-container {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  display: inline-block;
}

#patientPhoto {
  width: 120px;
  height: 160px;
  min-height: 160px; /* Tambahan baru */
  object-fit: cover;
  border-radius: 10px;
  border: 2px solid #007bff;
  background: #f0f0f0;
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}

/* Efek rotasi tombol plus saat aktif */
.add-btn {
  position: absolute;
  bottom: 0px;
  right: -60px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;
  background: #007bff;
  color: white;
  font-size: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.add-btn.active {
  transform: rotate(45deg) scale(1.1); /* rotasi 45Â° dan sedikit membesar */
  background: #0056b3;
}

/* Efek animasi keluar dari bawah ke atas */
.photo-options {
  position: absolute;
  bottom: 0;
  right: -60px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  opacity: 0;
  pointer-events: none;
  transform: translateY(20px);
  transition: all 0.35s ease;
}

.photo-options.show {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}

.photo-options.show .icon-btn {
  animation: fadeInUp 0.4s ease forwards;
}

.photo-options.show .icon-btn:nth-child(2) {
  animation-delay: 0.1s;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Tombol kamera & AI muncul dari atas tombol plus */
.photo-options {
  position: absolute;
  bottom: 60px;             /* titik awal di bawah tombol + */
  right: -60px;          /* sejajar dengan tombol + */
  display: flex;
  flex-direction: column; /* vertikal */
  align-items: center;
  gap:-50px;
  opacity: 0;
  pointer-events: none;
  transform: translateY(20px); /* posisi awal tersembunyi di bawah tombol + */
  transition: all 0.35s ease;
}

.photo-options.show {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0); /* naik ke posisi akhir */
}

.photo-options.show .icon-btn {
  animation: fadeInUp 0.4s ease forwards;
}

.photo-options.show .icon-btn:nth-child(2) {
  animation-delay: 0.1s;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.icon-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  color: white;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 3px 6px rgba(0,0,0,0.3);
  transition: transform 0.2s ease, background 0.2s ease;
}

.icon-btn:hover {
  background: #cdcdcd;
  transform: scale(1.15);
}

.camera-btn {
  background: #ffffff;
}

.ai-btn {
  background: #ffffff;
}
.icon-btn img.icon-img {
  width: 22px;
  height: 22px;
  object-fit: contain;
  pointer-events: none; /* supaya klik tetap ke tombol, bukan ke gambar */
}
#deleteDataBtn {
  background-color: #dc3545;
  color: white;
}
#deleteDataBtn:hover {
  background-color: #b02a37;
  transform: scale(1.05);
}

.delete-checkbox {
  transform: scale(1.2);
  cursor: pointer;
}

.delete-checkbox {
  transform: scale(1.3);
  cursor: pointer;
}

/* ===================================
   TOMBOL GLOBAL (EDIT, SIMPAN, BATAL)
   =================================== */
#editGlobalBtn, #saveGlobalBtn, #cancelGlobalBtn {
  transition: 0.2s ease;
  cursor: pointer;
}

#editGlobalBtn:hover {
  background:#0056b3 !important;
  transform:scale(1.05);
}

#saveGlobalBtn:hover {
  background:#116b78 !important;
  transform:scale(1.05);
}

#cancelGlobalBtn:hover {
  background:#5a5a5a !important;
  transform:scale(1.05);
}

/* ===================================
   TOMBOL HAPUS (NORMAL)
   =================================== */
#deleteDataBtn {
  transition:0.2s ease;
}

#deleteDataBtn:hover {
  background:#a40000 !important;
  transform:scale(1.05);
}

/* ===== TOMBOL EDIT / SIMPAN / BATAL ===== */
#editGlobalBtn:hover {
  background:#0056b3 !important;
  transform:scale(1.05);
}

#saveGlobalBtn:hover {
  background:#0f818f !important;
  transform:scale(1.05);
}

#cancelGlobalBtn:hover {
  background:#555 !important;
  transform:scale(1.05);
}

/* ===== TOMBOL HAPUS ===== */
#deleteDataBtn:hover {
  background:#a40000 !important;
  transform:scale(1.05);
}

/* ===== POPUP KONFIRMASI HAPUS BUTTON ===== */
.popup-confirm-btn:hover {
  background:#8a0000 !important;
  transform: scale(1.05);
}

.popup-cancel-btn:hover {
  background:#555 !important;
  transform: scale(1.05);
}
.info-table-wrapper {
  overflow-x: auto;
  width: 100%;
  border-radius: 10px;
}

  </style>
</head>
<body>
  <div class="container">
<h1>Detail Pemeriksaan Pasien</h1>

<!-- Foto & Nama Pasien -->
<div class="photo-section">
  <div class="photo-container">
    <img id="patientPhoto" src="https://via.placeholder.com/150x200?text=No+Photo" alt="Foto Pasien">

    <!-- Tombol tambah foto dipindahkan ke dalam photo-container -->
    <div class="photo-buttons">
      <button id="addPhotoBtn" class="add-btn">+</button>
      <div id="photoOptions" class="photo-options">
<button class="icon-btn camera-btn" title="Kamera/Galeri">
  <img src="camera.png" alt="Kamera" class="icon-img">
</button>
<button class="icon-btn ai-btn" title="AI">
  <img src="ai.png" alt="AI" class="icon-img">
</button>
      </div>
    </div>
  </div>
</div>

<!-- Nama Pasien -->
<h2 id="patientName" style="text-align:center; margin-bottom:1rem; color:#000000;"></h2>

    <div class="table-container">
<table>
  <thead>
    <tr>
      <th>Waktu Pemeriksaan</th> <!-- ðŸ”¹ Tambahkan di sini -->
      <th>Nama</th>
      <th>Umur</th>
      <th>Gender</th>
      <th>Detak Jantung (bpm)</th>
      <th>SpOâ‚‚ (%)</th>
      <th>Suhu Tubuh (CÂ°)</th>
      <th>Tekanan Darah (mmHg)</th>
      <th>Gula Darah (mg/dL)</th>
      <th>Hasil Diagnosa</th>
    </tr>
  </thead>
  <tbody>
    <tr id="dataRow">
      <td data-field="exam_time">-</td> <!-- ðŸ”¹ Tambahkan ini juga -->
      <td data-field="name">-</td>
      <td data-field="age">-</td>
      <td data-field="gender">-</td>
      <td data-field="heart_rate">-</td>
      <td data-field="spo2">-</td>
      <td data-field="temperature">-</td>
      <td data-field="blood_pressure">-</td>
      <td data-field="glucose">-</td>
      <td></td>
    </tr>
  </tbody>
</table>
</div>

<div class="btn-group">
  <button id="addDataBtn" onclick="addNewData()">Tambah Data</button>
  <button id="deleteDataBtn" onclick="toggleDeleteMode()">Hapus Data</button> <!-- ðŸ”¹ baru -->
  <button id="editGlobalBtn" style="background:#007bff; color:white;">Edit Data</button>
  <button id="saveGlobalBtn" style="background:#17a2b8; color:white; display:none;">Simpan</button>
  <button id="cancelGlobalBtn" style="background:#6c757d; color:white; display:none;">Batal</button>
  <button id="backBtn" onclick="goBack()">Kembali</button>
</div>
<!-- ============================ -->
<!-- ðŸ”” INFORMASI EDUKASI KESEHATAN -->
<!-- ============================ -->

<div class="info-box">
  <h2>Informasi Penting Mengenai Hasil Pemeriksaan</h2>
  <p class="info-note">
    <b>Catatan:</b> Warna pada hasil pemeriksaan tidak selalu menunjukkan penyakit pasti.
    Banyak faktor seperti stres, aktivitas fisik, suhu ruangan, kurang tidur, dan kualitas alat
    dapat mempengaruhi hasil. Jika warna merah muncul, tidak berarti kondisi berbahaya â€”
    gunakan tabel di bawah ini sebagai panduan awal.
  </p>

  <!-- ====================== -->
  <!-- TABEL EDUKASI DETAIL   -->
  <!-- ====================== -->
  <div class="info-table-wrapper">
  <table class="info-table">
    <thead>
      <tr>
        <th>Variabel</th>
        <th>Kategori</th>
        <th>Rentang Nilai</th>
        <th>Warna</th>
        <th>Makna</th>
        <th>Tindakan</th>
      </tr>
    </thead>

    <tbody>

      <!-- Heart Rate -->
      <tr>
        <td rowspan="3"><b>Detak Jantung</b><br><small>(Mayo Clinic)</small></td>
        <td>Normal</td>
        <td>60 â€“ 100 bpm</td>
        <td class="green">Hijau</td>
        <td>Detak jantung normal</td>
        <td>Tidak perlu tindakan</td>
      </tr>
      <tr>
        <td>Waspada</td>
        <td>50â€“59 atau 101â€“120 bpm</td>
        <td class="yellow">Kuning</td>
        <td>Dipengaruhi stres, dehidrasi, kurang tidur</td>
        <td>Istirahat, hidrasi, kurangi kafein</td>
      </tr>
      <tr>
        <td>Bahaya</td>
        <td>&lt;50 atau &gt;120 bpm</td>
        <td class="red">Merah</td>
        <td>Risiko aritmia atau gangguan jantung</td>
        <td>Segera periksa ke dokter</td>
      </tr>

      <!-- SpO2 -->
      <tr class="variable-start">
        <td rowspan="3"><b>SpOâ‚‚</b><br><small>(WHO / NIH)</small></td>
        <td>Normal</td>
        <td>â‰¥ 95%</td>
        <td class="green">Hijau</td>
        <td>Oksigenasi normal</td>
        <td>Tidak perlu tindakan</td>
      </tr>
      <tr>
        <td>Waspada</td>
        <td>92â€“94%</td>
        <td class="yellow">Kuning</td>
        <td>Gangguan pernapasan ringan</td>
        <td>Latihan napas, duduk tegak</td>
      </tr>
      <tr>
        <td>Bahaya</td>
        <td>&lt; 92%</td>
        <td class="red">Merah</td>
        <td>Hipoksia</td>
        <td>Segera ke fasilitas kesehatan</td>
      </tr>

      <!-- Temperature -->
      <tr class="variable-start">
        <td rowspan="4"><b>Suhu Kulit</b><br><small>(Journal of Physiological Anthropology)</small></td>
        <td>Normal</td>
        <td>32.5Â°C â€“ 35.5Â°C</td>
        <td class="green">Hijau</td>
        <td>Suhu kulit normal</td>
        <td>Tidak perlu tindakan</td>
      </tr>
      <tr>
        <td>Waspada</td>
        <td>35.6Â°C â€“ 36.5Â°C</td>
        <td class="yellow">Kuning</td>
        <td>Peningkatan ringan</td>
        <td>Minum air, cari ruangan sejuk</td>
      </tr>
      <tr>
        <td>Rendah</td>
        <td>&lt; 32.5Â°C</td>
        <td class="red">Merah</td>
        <td>Hipotermia kulit</td>
        <td>Hangatkan tubuh</td>
      </tr>
      <tr>
        <td>Tinggi</td>
        <td>&gt; 36.5Â°C</td>
        <td class="red">Merah</td>
        <td>Demam tinggi kulit</td>
        <td>Kompres hangat, observasi</td>
      </tr>

      <!-- Glucose -->
      <tr class="variable-start">
        <td rowspan="3"><b>Gula Darah (Mode A â€” Puasa)</b><br><small>(ADA 2024)</small></td>
        <td>Normal</td>
        <td>70â€“99 mg/dL</td>
        <td class="green">Hijau</td>
        <td>Normal</td>
        <td>Tidak perlu tindakan</td>
      </tr>
      <tr>
        <td>Pradiabetes</td>
        <td>100â€“125 mg/dL</td>
        <td class="yellow">Kuning</td>
        <td>Kandungan gula meningkat</td>
        <td>Kurangi gula, olahraga rutin</td>
      </tr>
      <tr>
        <td>Diabetes</td>
        <td>â‰¥ 126 mg/dL</td>
        <td class="red">Merah</td>
        <td>Diagnosis diabetes</td>
        <td>Periksa ke dokter</td>
      </tr>

      <tr>
        <td rowspan="3"><b>Gula Darah (Mode B â€” 2 Jam Setelah Makan)</b><br><small>(ADA 2024)</small></td>
        <td>Normal</td>
        <td>&lt; 140 mg/dL</td>
        <td class="green">Hijau</td>
        <td>Normal</td>
        <td>Tidak perlu tindakan</td>
      </tr>
      <tr>
        <td>Pradiabetes</td>
        <td>140â€“199 mg/dL</td>
        <td class="yellow">Kuning</td>
        <td>Peningkatan glukosa</td>
        <td>Diet sehat & olahraga</td>
      </tr>
      <tr>
        <td>Diabetes</td>
        <td>â‰¥ 200 mg/dL</td>
        <td class="red">Merah</td>
        <td>Diagnosis diabetes</td>
        <td>Evaluasi medis</td>
      </tr>

      <!-- Blood Pressure -->
      <tr class="variable-start">
        <td rowspan="5"><b>Tekanan Darah</b><br><small>(AHA 2017)</small></td>
        <td>Normal</td>
        <td>&lt;120 / &lt;80</td>
        <td class="green">Hijau</td>
        <td>Normal</td>
        <td>Tidak perlu tindakan</td>
      </tr>
      <tr>
        <td>Elevated</td>
        <td>120â€“129 / &lt;80</td>
        <td class="yellow">Kuning</td>
        <td>Cenderung meningkat</td>
        <td>Kurangi garam, olahraga ringan</td>
      </tr>
      <tr>
        <td>Hipertensi Stage 1</td>
        <td>130â€“139 / 80â€“89</td>
        <td class="yellow">Kuning</td>
        <td>Risiko meningkat</td>
        <td>Perbaiki gaya hidup</td>
      </tr>
      <tr>
        <td>Hipertensi Stage 2</td>
        <td>â‰¥140 / â‰¥90</td>
        <td class="red">Merah</td>
        <td>Tekanan tinggi berbahaya</td>
        <td>Konsultasi medis</td>
      </tr>
      <tr>
        <td>Crisis</td>
        <td>â‰¥180 / â‰¥120</td>
        <td class="red">Merah</td>
        <td>Kondisi darurat</td>
        <td>Segera ke IGD</td>
      </tr>

      <!-- Diagnosis -->
      <tr class="variable-start">
        <td rowspan="3"><b>Diagnosa (SVM)</b></td>
        <td>Rendah</td>
        <td>-</td>
        <td class="green">Hijau</td>
        <td>Risiko rendah</td>
        <td>Pantau rutin</td>
      </tr>
      <tr>
        <td>Sedang</td>
        <td>-</td>
        <td class="yellow">Kuning</td>
        <td>Risiko moderat</td>
        <td>Perbaiki gaya hidup</td>
      </tr>
      <tr>
        <td>Tinggi</td>
        <td>-</td>
        <td class="red">Merah</td>
        <td>Risiko tinggi</td>
        <td>Pemeriksaan lanjutan</td>
      </tr>

    </tbody>
  </table>
</div>

<!-- ============================ -->
<!-- CSS untuk tabel edukasi       -->
<!-- ============================ -->

<style>
.info-box {
  margin-top: 2rem;
  background: white;
  padding: 1.5rem;
  border-radius: 14px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

.info-box h2 {
  text-align: center;
  margin-bottom: 1rem;
}

.info-note {
  background: #e8f4ff;
  padding: 1rem;
  border-left: 5px solid #007BFF;
  border-radius: 8px;
  font-size: 0.95rem;
  margin-bottom: 1.5rem;
}

.info-table {
  width: 100%;
  border-collapse: collapse;
}

.info-table th {
  background: #007BFF;
  color: white;
  padding: 10px;
  text-align: center;
}

.info-table td {
  border: 1px solid #ccc;
  padding: 10px;
  text-align: center;
  background: #fafafa;
}

/* warna indikator */
.green { color: green; font-weight: bold; }
.yellow { color: orange; font-weight: bold; }
.red { color: red; font-weight: bold; }

/* Garis tebal pemisah tiap variabel */
.info-table tr.variable-start td {
  border-top: 3px solid #000 !important;
}

</style>


  </div>

  <!-- Popup Animasi -->
  <div id="popup-bg">
    <div id="popup">
      <img id="popup-icon" src="" alt="Status Icon">
      <p id="popup-message"></p>
    </div>
  </div>

  <script>
  // === Fungsi Popup Animasi ===
  function showPopup(success = true, message = "Berhasil!") {
    const popupBg = document.getElementById("popup-bg");
    const popup = document.getElementById("popup");
    const icon = document.getElementById("popup-icon");
    const msg = document.getElementById("popup-message");

    icon.src = success ? "success.gif" : "failed.gif";
    msg.textContent = message;

    popupBg.classList.add("show");
    popup.classList.add("show");

    // Hilangkan popup setelah 1.8 detik dengan efek fade out
    setTimeout(() => {
      popup.classList.remove("show");
      popupBg.style.opacity = "0";
      setTimeout(() => {
        popupBg.classList.remove("show");
        popupBg.style.opacity = "1";
      }, 400);
    }, 1800);
  }

  // --- Konfigurasi Supabase ---
  const SUPABASE_URL = "https://agyeeuaelqgyusbtnrgn.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFneWVldWFlbHFneXVzYnRucmduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTUyMjMsImV4cCI6MjA3MzU5MTIyM30.HmXvR8koQpxYo1Mx-zWP3tlHxBPPo7RInFHjg8tAJtQ";

  const { createClient } = supabase;
  const client = createClient(SUPABASE_URL, SUPABASE_KEY);

  // Ambil patient_id dari URL
  const urlParams = new URLSearchParams(window.location.search);
  const patientId = urlParams.get("id");

  const role = localStorage.getItem("role");

  function removeEditColumnIfGuest() {
  if (role === "admin") return; // Jika admin, biarkan tombol edit ada

  // Hapus seluruh kolom edit dari tabel
  const rows = document.querySelectorAll("tbody tr");
  
  rows.forEach(row => {
    const lastCell = row.lastElementChild;
    // Jika lastCell berisi tombol edit
    if (lastCell && lastCell.querySelector(".row-edit-btn")) {
      lastCell.remove();
    }
  });

  // Hapus juga header edit kalau ada
  const thead = document.querySelector("thead tr");
  if (thead && thead.children.length > 10) {
    thead.lastElementChild.remove();
  }
}

  if (role !== "admin") {
      document.getElementById("addDataBtn").style.display = "none";
      document.getElementById("deleteDataBtn").style.display = "none";
      const photoButtons = document.querySelector(".photo-buttons");
  if (photoButtons) {
    photoButtons.style.display = "none"; // sembunyikan seluruh tombol tambah foto & opsi
  }

  // Hilangkan tombol edit baris
  const style = document.createElement("style");
  style.innerHTML = `.row-edit-btn { display:none !important }`;
  document.head.appendChild(style);
}

  // --- Ambil data pasien + hasil pemeriksaan ---
async function loadPatientData() {
  if (!patientId) {
    showPopup(false, "ID pasien tidak ditemukan!");
    return;
  }

  // Ambil data pasien
  const { data: patient, error: patientError } = await client
    .from("patients")
    .select("*")
    .eq("id", patientId)
    .single();

  // Ambil semua data pemeriksaan pasien ini
  const { data: measurementData, error: measureError } = await client
    .from("measurements")
    .select("*")
    .eq("patient_id", patientId)
    .order("created_at", { ascending: false }); // urutkan dari baru ke lama

  if (patientError) {
    console.error("Gagal mengambil data pasien:", patientError);
    showPopup(false, "Gagal mengambil data pasien!");
    return;
  }

  // Nama pasien di bawah foto
  document.getElementById("patientName").textContent = patient.name || "Nama tidak tersedia";

  const tbody = document.querySelector("tbody");
  tbody.innerHTML = ""; // kosongkan dulu, biar nanti diisi ulang semua riwayat
  await deleteEmptyRows();
  // Loop semua riwayat pengukuran
  (measurementData || []).forEach(measurement => {
    const waktu = measurement.created_at
      ? new Date(measurement.created_at).toLocaleString("id-ID", {
          weekday: "long",
          day: "numeric",
          month: "long",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit"
        })
      : "-";

const row = document.createElement("tr");
row.innerHTML = `
  <td>${waktu}</td>
  <td data-field="name">${patient.name || "-"}</td>
  <td data-field="age">${patient.age || "-"}</td>
  <td data-field="gender">${patient.gender || "-"}</td>
  <td data-field="heart_rate">${measurement.heart_rate ?? "-"}</td>
  <td data-field="spo2">${measurement.spo2 ?? "-"}</td>
  <td data-field="temperature">${measurement.temperature ?? "-"}</td>
  <td data-field="blood_pressure">
  ${formatBloodPressure(measurement.blood_pressure)}
</td>
  <td data-field="glucose">${measurement.glucose ?? "-"}</td>
  <td class="diagnosis-cell">loading...</td>
`;
tbody.appendChild(row);
applyColor(measurement.heart_rate, "heart_rate", row.children[4]);
applyColor(measurement.spo2, "spo2", row.children[5]);
applyColor(measurement.temperature, "temperature", row.children[6]);
applyColor(measurement.blood_pressure, "blood_pressure", row.children[7]);
applyColor(measurement.glucose, "glucose", row.children[8]);

  });

await jalankanDiagnosaSVM();

  if (!measurementData || measurementData.length === 0) {
    const row = document.createElement("tr");
    row.innerHTML = `<td colspan="10">Belum ada data pemeriksaan</td>`;
    tbody.appendChild(row);
  }
}
  function formatBloodPressure(value) {
  if (!value || !value.includes("/")) {
    return `<span style="color:black;">-</span>`;
  }

  const [sys, dia] = value.split("/").map(v => v.trim());

  return `
    <span class="bp-sys" data-sys="${sys}">${sys}</span>
    /
    <span class="bp-dia" data-dia="${dia}">${dia}</span>
  `;
}
function applyColor(value, type, cell) {

  // Jika kosong, null, atau "-" â†’ tidak diberi warna
  if (!value || value === "-" || value === null) {
    cell.style.color = "black";
    return;
  }

  // Hilangkan huruf a/b untuk gula darah
  let raw = String(value).replace(/[ab]/i, "");
  let num = parseFloat(raw);

  // Jika bukan angka valid â†’ biarkan hitam
  if (isNaN(num)) {
    cell.style.color = "black";
    return;
  }

  switch (type) {

    /* ==========================
       1. DETAK JANTUNG
    ========================== */
    case "heart_rate":
      if (num >= 60 && num <= 100) cell.style.color = "green";
      else if ((num > 100 && num <= 120) || (num >= 50 && num < 60))
        cell.style.color = "orange";
      else cell.style.color = "red";
      break;

    /* ==========================
       2. SpO2
    ========================== */
    case "spo2":
      if (num >= 95) cell.style.color = "green";
      else if (num >= 92) cell.style.color = "orange";
      else cell.style.color = "red";
      break;

    /* ==========================
       3. SUHU KULIT
    ========================== */
    case "temperature":
      if (num >= 32.5 && num <= 35.5) cell.style.color = "green";
      else if (num > 35.5 && num <= 36.5) cell.style.color = "orange";
      else cell.style.color = "red";
      break;

    /* ==========================
       4. GULA DARAH A/B
    ========================== */
    case "glucose":
      const mode = value.slice(-1).toLowerCase();

      if (mode === "a") { // PUASA
        if (num >= 70 && num <= 99) cell.style.color = "green";
        else if (num >= 100 && num <= 125) cell.style.color = "orange";
        else cell.style.color = "red";
      }

      else if (mode === "b") { // 2 JAM SETELAH MAKAN
        if (num < 140) cell.style.color = "green";
        else if (num <= 199) cell.style.color = "orange";
        else cell.style.color = "red";
      }

      else { 
        if (num >= 70 && num <= 140) cell.style.color = "green";
        else if (num <= 199) cell.style.color = "orange";
        else cell.style.color = "red";
      }
      break;

    /* ==========================
       5. TEKANAN DARAH
    ========================== */
case "blood_pressure":
  if (!value.includes("/")) {
    cell.style.color = "black";
    return;
  }

  let [sys, dia] = value.split("/").map(Number);

  const sysSpan = cell.querySelector(".bp-sys");
  const diaSpan = cell.querySelector(".bp-dia");

  // Warnai SYSTOLIC
  if (sys < 120) sysSpan.style.color = "green";
  else if (sys <= 139) sysSpan.style.color = "orange";
  else sysSpan.style.color = "red";

  // Warnai DIASTOLIC
  if (dia < 80) diaSpan.style.color = "green";
  else if (dia <= 89) diaSpan.style.color = "orange";
  else diaSpan.style.color = "red";

  break;
  }
}







async function saveEditedRow(row) {
  const inputs = row.querySelectorAll("input[data-field]");

  const allowedFields = [
    "heart_rate",
    "spo2",
    "temperature",
    "blood_pressure",
    "glucose"
  ];

  const updateData = {};

  inputs.forEach(inp => {
    const field = inp.dataset.field;
    if (allowedFields.includes(field)) {
      updateData[field] = inp.value;
    }
  });

  // cari measurement id sesuai index row
  const index = Array.from(row.parentElement.children).indexOf(row);

  const { data: ids } = await client
    .from("measurements")
    .select("id")
    .eq("patient_id", patientId)
    .order("created_at", { ascending: false });

  const measurementId = ids[index]?.id;

  if (!measurementId) {
    showPopup(false, "ID measurement tidak ditemukan!");
    return;
  }

  const { error } = await client
    .from("measurements")
    .update(updateData)
    .eq("id", measurementId);

  if (error) {
    console.error(error);
    showPopup(false, "Gagal menyimpan!");
    return;
  }

  showPopup(true, "Berhasil disimpan!");
  rowBeingEdited = null;
  loadPatientData();
}




async function jalankanDiagnosaSVM() {
    const SERVER_URL = "https://sv-h35s.onrender.com";

    const rows = document.querySelectorAll("table tbody tr");

    for (const row of rows) {

        // kalau ini baris "Belum ada data" â†’ skip
        if (row.querySelector('[data-field="name"]') === null) continue;

        // ambil data berdasarkan atribut data-field
        const data = {
            name: row.querySelector('[data-field="name"]').innerText,
            age: row.querySelector('[data-field="age"]').innerText,
            gender: row.querySelector('[data-field="gender"]').innerText,
            heart_rate: row.querySelector('[data-field="heart_rate"]').innerText,
            spo2: row.querySelector('[data-field="spo2"]').innerText,
            temperature: row.querySelector('[data-field="temperature"]').innerText,
            blood_pressure: row.querySelector('[data-field="blood_pressure"]').innerText,
            glucose: row.querySelector('[data-field="glucose"]').innerText
        };

        try {
            const response = await fetch(SERVER_URL + "/predict_svm", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            row.querySelector(".diagnosis-cell").innerText = result.risk;
            const diagCell = row.querySelector(".diagnosis-cell");
const risk = result.risk.toLowerCase();
if (risk.includes("low") || risk.includes("rendah")) diagCell.style.color = "green";
else if (risk.includes("medium") || risk.includes("sedang")) diagCell.style.color = "orange";
else if (risk.includes("high") || risk.includes("tinggi")) diagCell.style.color = "red";

        } catch (err) {
            row.querySelector(".diagnosis-cell").innerText = "Error";
        }
    }
}

  // === Fungsi Tambah Data Baru ===
async function addNewData() {
  try {
    // ðŸ”¹ 1ï¸âƒ£ Update pasien aktif di tabel active_patient
    const { error: activeError } = await client
      .from("active_patient")
      .update({ current_id: patientId })
      .eq("id", 1);

    if (activeError) {
      console.error("Gagal update pasien aktif:", activeError.message);
      showPopup(false, "Gagal mengatur pasien aktif!");
      return;
    }

    // ðŸ”¹ 2ï¸âƒ£ Tambahkan data kosong baru ke tabel measurements
    const { error: insertError } = await client
      .from("measurements")
      .insert({
        patient_id: patientId,
        heart_rate: null,
        spo2: null,
        temperature: null,
        blood_pressure: null,
        glucose: null,
        //diagnosis: null
      });

    if (insertError) {
      console.error("Gagal menambah data baru:", insertError.message);
      showPopup(false, "Gagal menambah data baru!");
      return;
    }

    showPopup(true, "Kolom data baru berhasil ditambahkan!");
    await loadPatientData(); // refresh data
  } catch (err) {
    console.error("Kesalahan saat menambah data:", err);
    showPopup(false, "Terjadi kesalahan saat menambah data!");
  }
}

  function goBack() {
    window.history.back();
  }
  
let deleteMode = false;
let selectedIds = [];

async function toggleDeleteMode() {
  const deleteBtn = document.getElementById("deleteDataBtn");
  const tbody = document.querySelector("tbody");

  // Ambil ID measurement sesuai urutan tabel
  const { data: measurementData, error } = await client
    .from("measurements")
    .select("id")
    .eq("patient_id", patientId)
    .order("created_at", { ascending: false });

  if (error) {
    console.error("Gagal ambil data ID:", error);
    showPopup(false, "Gagal memuat data ID!");
    return;
  }

  // === Mode aktifkan hapus ===
  if (!deleteMode) {
    deleteMode = true;
    deleteBtn.textContent = "Konfirmasi Hapus";
    selectedIds = [];

    const rows = tbody.querySelectorAll("tr");

    rows.forEach((row, i) => {
      const id = measurementData?.[i]?.id;
      if (!id) return;

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "delete-checkbox";
      cb.dataset.id = id;

      // event ubah checkbox
      cb.addEventListener("change", (e) => {
        if (e.target.checked) selectedIds.push(id);
        else selectedIds = selectedIds.filter((x) => x !== id);
      });

      // buat sel baru di kanan (setelah kolom diagnosa)
      const cbCell = document.createElement("td");
      cbCell.appendChild(cb);
      cbCell.style.background = "#f9f9f9";
      cbCell.style.borderLeft = "1px solid #ccc";
      cbCell.style.textAlign = "center";
      row.appendChild(cbCell);
    });
  }

  // Munculkan tombol batal hapus
if (!document.getElementById("cancelDeleteBtn")) {
  const cancelBtn = document.createElement("button");
  cancelBtn.id = "cancelDeleteBtn";
  cancelBtn.textContent = "Batal";
  cancelBtn.style.background = "#6c757d";
  cancelBtn.style.color = "white";
  cancelBtn.style.marginLeft = "6px";
  cancelBtn.style.borderRadius = "8px";
  cancelBtn.style.padding = "0.5rem 1rem";
  cancelBtn.style.cursor = "pointer";
  cancelBtn.style.transition = "0.2s";

  cancelBtn.onmouseover = () => cancelBtn.style.background = "#555";
  cancelBtn.onmouseout  = () => cancelBtn.style.background = "#6c757d";

  cancelBtn.onclick = () => {
    deleteMode = false;
    deleteBtn.textContent = "Hapus Data";

    document.querySelectorAll(".delete-checkbox").forEach(cb => cb.parentElement.remove());
    document.getElementById("cancelDeleteBtn").remove();
  };

  deleteBtn.after(cancelBtn);
}

  // === Mode konfirmasi hapus ===
  else {
    deleteMode = false;
    deleteBtn.textContent = "Hapus Data";

    if (selectedIds.length === 0) {
      showPopup(false, "Tidak ada data yang dipilih!");
      document.querySelectorAll(".delete-checkbox").forEach(cb => cb.parentElement.remove());
      return;
    }

    // Popup konfirmasi custom
    const confirmBox = document.createElement("div");
    confirmBox.style.position = "fixed";
    confirmBox.style.inset = "0";
    confirmBox.style.background = "rgba(0,0,0,0.5)";
    confirmBox.style.display = "flex";
    confirmBox.style.justifyContent = "center";
    confirmBox.style.alignItems = "center";
    confirmBox.style.zIndex = "1000";

    confirmBox.innerHTML = `
      <div style="background:white; padding:2rem; border-radius:12px; text-align:center; max-width:350px;">
        <p style="margin-bottom:1rem; font-weight:600;">Yakin ingin menghapus ${selectedIds.length} data pemeriksaan?</p>
        <button id="yesDelete" class="popup-confirm-btn"
 style="background:#dc3545; color:white; border:none; padding:0.6rem 1.3rem; border-radius:8px; margin-right:8px;">
 Ya
</button>
<button id="noDelete" class="popup-cancel-btn"
 style="background:#6c757d; color:white; border:none; padding:0.6rem 1.3rem; border-radius:8px;">
 Batal
</button>

    `;
    document.body.appendChild(confirmBox);

    document.getElementById("noDelete").onclick = () => {
      confirmBox.remove();
      document.querySelectorAll(".delete-checkbox").forEach(cb => cb.parentElement.remove());
      showPopup(false, "Penghapusan dibatalkan");
    };

    document.getElementById("yesDelete").onclick = async () => {
      confirmBox.remove();
      try {
        const { error: delError } = await client
          .from("measurements")
          .delete()
          .in("id", selectedIds);

        if (delError) throw delError;
        showPopup(true, `${selectedIds.length} data berhasil dihapus!`);
        await loadPatientData();
      } catch (err) {
        console.error("âŒ Gagal menghapus data:", err);
        showPopup(false, "Terjadi kesalahan saat menghapus data!");
      }
    };
  }
}

  // === Menampilkan / menyembunyikan tombol kamera & AI ===
document.getElementById("addPhotoBtn").addEventListener("click", () => {
  const options = document.getElementById("photoOptions");
  options.classList.toggle("show");
});

// === Toggle tombol kamera & AI ===
document.getElementById("addPhotoBtn").addEventListener("click", () => {
  const options = document.getElementById("photoOptions");
  options.classList.toggle("show");
});

// === Ambil foto pasien dari Supabase ===
async function loadPatientPhoto() {
  try {
    const { data, error } = await client
      .from("patient_photos")
      .select("photo_url")
      .eq("patient_id", patientId)
      .single();

    const photoEl = document.getElementById("patientPhoto");
    if (error || !data) {
      photoEl.src = "https://via.placeholder.com/150x200?text=No+Photo";
      return;
    }

    photoEl.src = data.photo_url;
  } catch (err) {
    console.warn("Gagal memuat foto pasien:", err);
    document.getElementById("patientPhoto").src =
      "https://via.placeholder.com/150x200?text=No+Photo";
  }
}

async function uploadPatientPhoto(file) {
  try {
    const fileName = `${patientId}_${Date.now()}.jpg`;
    const { data, error } = await client.storage
      .from("patient_photos")
      .upload(fileName, file, { upsert: true });

    if (error) throw error;
    console.log("File berhasil diupload:", data);

    // Ambil URL publik
    const { data: urlData } = client.storage
      .from("patient_photos")
      .getPublicUrl(fileName);

    const photoUrl = urlData.publicUrl;

// ðŸ” 1ï¸âƒ£ Cek apakah pasien ini sudah punya foto sebelumnya
const { data: oldPhoto, error: oldError } = await client
  .from("patient_photos")
  .select("photo_url")
  .eq("patient_id", patientId)
  .single();

if (oldPhoto && oldPhoto.photo_url) {
  try {
    // Ambil path lengkap mulai dari nama bucket
    const startIndex = oldPhoto.photo_url.indexOf("patient_photos/");
    const oldFilePath = oldPhoto.photo_url.substring(startIndex + "patient_photos/".length);

    console.log("ðŸ—‘ï¸ Menghapus file lama:", oldFilePath);

    const { error: deleteFileError } = await client.storage
      .from("patient_photos")
      .remove([oldFilePath]);

    if (deleteFileError) {
      console.warn("âš ï¸ Gagal hapus file lama:", deleteFileError.message);
    } else {
      console.log("âœ… File lama berhasil dihapus:", oldFilePath);
    }

    await client.from("patient_photos").delete().eq("patient_id", patientId);
  } catch (err) {
    console.warn("âš ï¸ Error saat menghapus foto lama:", err);
  }
}


// ðŸ’¾ 4ï¸âƒ£ Simpan data foto baru
const { error: insertError } = await client
  .from("patient_photos")
  .insert({
    patient_id: patientId,
    photo_url: photoUrl,
    uploaded_at: new Date().toISOString()
  });

if (insertError) {
  console.error("âŒ Gagal menyimpan foto baru:", insertError.message);
  showPopup(false, "Gagal menyimpan foto baru!");
} else {
  console.log("âœ… Foto baru tersimpan:", photoUrl);
  showPopup(true, "Foto pasien berhasil diperbarui!");
}

    if (insertError) throw insertError;

    console.log("Foto tersimpan di database:", photoUrl);
    showPopup(true, "Foto berhasil diunggah!");
    document.getElementById("patientPhoto").src = photoUrl; // tampilkan langsung
  } catch (err) {
    console.error("Gagal upload foto:", err);
    showPopup(false, "Gagal mengunggah foto!");
  }
}

// === Jalankan setelah load data utama ===
loadPatientData().then(loadPatientPhoto);
const addBtn = document.getElementById("addPhotoBtn");
addBtn.addEventListener("click", () => {
  const options = document.getElementById("photoOptions");
  options.classList.toggle("show");
  addBtn.classList.toggle("active"); // putar tombol plus
});

// === Fungsi buka kamera atau galeri + upload ke Supabase ===
document.querySelector(".camera-btn").addEventListener("click", async () => {
  try {
    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.accept = "image/*";
    fileInput.capture = "environment";

    fileInput.onchange = async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      console.log("ðŸ“¸ File dipilih:", file.name);
      showPopup(true, "Mengunggah foto...");

      await uploadPatientPhoto(file);
    };

    fileInput.click();
  } catch (err) {
    console.error("âŒ ERROR:", err);
    showPopup(false, "Gagal mengunggah foto pasien!");
  }
});
async function deleteEmptyRows() {
  await client
    .from("measurements")
    .delete()
    .is("heart_rate", null)
    .eq("patient_id", patientId);
}

/* ==========================================================
   ðŸŒŸ FITUR EDIT GLOBAL â€” hanya bisa dipakai oleh ADMIN
   ========================================================== */
let editing = false;
let originalValues = {};   // Menyimpan nilai asli per baris

const editBtn = document.getElementById("editGlobalBtn");
const saveBtn = document.getElementById("saveGlobalBtn");
const cancelBtn = document.getElementById("cancelGlobalBtn");

if (role !== "admin") {
  editBtn.style.display = "none";
  saveBtn.style.display = "none";
  cancelBtn.style.display = "none";
}

/* ==========================================================
   1ï¸âƒ£ MASUK MODE EDIT
   ========================================================== */
editBtn.addEventListener("click", () => {
  if (editing) return;

  editing = true;
  editBtn.style.display = "none";
  saveBtn.style.display = "inline-block";
  cancelBtn.style.display = "inline-block";

  const rows = document.querySelectorAll("tbody tr");

  rows.forEach((row, idx) => {
    const fields = ["heart_rate", "spo2", "temperature", "blood_pressure", "glucose"];

    originalValues[idx] = {};

    fields.forEach(field => {
      const cell = row.querySelector(`td[data-field="${field}"]`);
      if (!cell) return;

      originalValues[idx][field] = cell.innerText.trim();

      cell.innerHTML = `
        <input type="text" data-field="${field}" value="${originalValues[idx][field]}">
      `;
    });
  });
});

/* ==========================================================
   2ï¸âƒ£ BATALKAN EDIT
   ========================================================== */
cancelBtn.addEventListener("click", () => {
  if (!editing) return;

  const rows = document.querySelectorAll("tbody tr");

  rows.forEach((row, idx) => {
    const fields = ["heart_rate", "spo2", "temperature", "blood_pressure", "glucose"];

    fields.forEach(field => {
      const cell = row.querySelector(`td[data-field="${field}"]`);
      if (!cell) return;

      cell.innerHTML = originalValues[idx][field];
    });
  });

  editing = false;
  editBtn.style.display = "inline-block";
  saveBtn.style.display = "none";
  cancelBtn.style.display = "none";
});

/* ==========================================================
   3ï¸âƒ£ SIMPAN SEMUA EDIT
   ========================================================== */
saveBtn.addEventListener("click", async () => {
  const rows = document.querySelectorAll("tbody tr");

  const { data: measurementIds } = await client
    .from("measurements")
    .select("id")
    .eq("patient_id", patientId)
    .order("created_at", { ascending: false });

  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    const id = measurementIds?.[i]?.id;
    if (!id) continue;

    const inputs = row.querySelectorAll("input[data-field]");
    const updateData = {};

    inputs.forEach(inp => {
      updateData[inp.dataset.field] = inp.value;
    });

    await client.from("measurements").update(updateData).eq("id", id);
  }

  showPopup(true, "Semua data berhasil disimpan!");

  editing = false;
  editBtn.style.display = "inline-block";
  saveBtn.style.display = "none";
  cancelBtn.style.display = "none";

  loadPatientData(); // refresh tabel
});

  </script>
</body>
</html>
